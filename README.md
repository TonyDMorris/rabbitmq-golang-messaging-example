# RabbitMQ Golang Messaging Demo

> A demo project to show the basics of secure messaging using Golang and rabbitMQ.

## What Does It Do ?
- the system is composed of 3 containers a producer, a consumer, and rabbitMQ
- The producer sends messages to a rabbitmq queue at intervals determined by an environment variable in the docker compose file 
- The consumer "processes" the messages and displays a count in the terminal

## What Does It Demonstrate ?


 The rabbitMQ configuration builds on the standard rabbitmq release image by configuring full TLS encryption before the container runs, 
 this ensures that any clients connecting to the container must have valid tls certificates.
 
 The deployment is configured with default username and password in this instance but using a ci/cd pipeline any level of 
 configuration can be passed in to authenticate clients  
 
   - Although the configuration is not final it's easy to see how this method can be extended from self signed certificates for development, to the implementation of a trusted 
   certificate authority.
   
  the producer has access to tls configuration which would allow it to securely communicate with the broker 
   - although the certificate validation is disabled in this example, in production certificates could be issued by a valid certificate authority and distributed to the hosts via volumes
 
  The consumer processes messages within Go routines this allows for huge workloads to be processed concurrently.
  in addition to this the consumer is highly scalable and will fit perfectly into a cluster configuration.
 
 
## Requirements

- [Docker](https://docs.docker.com/engine/install/)


### Setup

- Clone this repo to your local machine using https://github.com/TonyDMorris/rabbitmq-golang-messaging-example
```bash
git clone https://github.com/TonyDMorris/rabbitmq-golang-messaging-example
```
- run with docker compose
```bash
docker-compose up --build 
```
- the output should look like this
```bash
rabbitmq    | 2020-08-03 22:00:48.048 [info] <0.745.0> accepting AMQP connection <0.745.0> (172.21.0.3:42450 -> 172.21.0.2:5671)
rabbitmq    | 2020-08-03 22:00:48.051 [info] <0.745.0> connection <0.745.0> (172.21.0.3:42450 -> 172.21.0.2:5671): user 'rabbitmq' authenticated and granted access to vhost '/'
producer_1  | [*] Connected sending messages.messenger up and running
rabbitmq    | 2020-08-03 22:00:48.319 [info] <0.762.0> accepting AMQP connection <0.762.0> (172.21.0.4:44006 -> 172.21.0.2:5671)
rabbitmq    | 2020-08-03 22:00:48.323 [info] <0.762.0> connection <0.762.0> (172.21.0.4:44006 -> 172.21.0.2:5671): user 'rabbitmq' authenticated and granted access to vhost '/'
consumer_1  | connected to rabbitMQconsumer up and running
consumer_1  | 2020/08/03 22:00:48  [*] Waiting for messages.
consumer_1  | 2020/08/03 22:00:48 processed message 1
consumer_1  | 2020/08/03 22:00:48 processed message 2
consumer_1  | 2020/08/03 22:00:48 processed message 3
consumer_1  | 2020/08/03 22:00:48 processed message 4
consumer_1  | 2020/08/03 22:00:48 processed message 5
```

## Configuration

 - the rabbitMQ container TLS configuration is generated by a RUN command within the dockerfile and environemnt 
 variables within the docker-compose file 
 
 
 ./rabbitmq/dockerfile
 ```dockerfile
RUN apt-get update && apt-get install make \
    && cd tls-gen/basic \
    && make PASSWORD=bunnies CN=rabbitmq \
    && make verify \
    && make info \
    && chown -R rabbitmq:rabbitmq /tls-gen \
    && ls -l ./result \
    && echo 'ssl_options.password = bunnies' >> /etc/rabbitmq/rabbitmq.conf
``` 
./docket-compose.yml
```yaml
rabbitmq:
    build: ./rabbitmq
    container_name: rabbitmq
    hostname: rabbitmq
    volumes:
      - rabbitmqdata:/var/lib/rabbitmq

    ports:
      - "15671:15671"
      - "15672:15672"
      - "5672:5672"
      - "5671:5671"
      - "25672:25672"
    environment:
      - RABBITMQ_ERLANG_COOKIE='takeMyCookies'
      - RABBITMQ_DEFAULT_USER=rabbitmq
      - RABBITMQ_DEFAULT_PASS=rabbitmq
      - RABBITMQ_SSL_CERTFILE=/tls-gen/basic/result/server_certificate.pem
      - RABBITMQ_SSL_KEYFILE=/tls-gen/basic/result/server_key.pem
      - RABBITMQ_SSL_CACERTFILE=/tls-gen/basic/result/ca_certificate.pem
      - RABBITMQ_SSL_VERIFY=verify_none
      - RABBITMQ_SSL_FAIL_IF_NO_PEER_CERT=false
```

The producer can be configured to send messages varying frequencies via the configuration of an environment variable 
in the docker- compose file

./docker.compose.yml

```yaml
producer:
    build: ./producer
    environment:
      EVERY_X_MILLISECONDS: 10
```




## License

[![License](http://img.shields.io/:license-mit-blue.svg?style=flat-square)](http://badges.mit-license.org)

- **[MIT license](http://opensource.org/licenses/mit-license.php)**
- Copyright 2020 Â© <a href="https://me.towidomo.dev" target="_blank">Tony Morris</a>.
